# HarmonyDB Sequence Diagrams

## 1. Write Operation Sequence

```
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│ Client │  │  Node  │  │  Raft  │  │ Ready  │  │  WAL   │  │ B+Tree │
│        │  │  API   │  │        │  │Handler │  │        │  │        │
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │           │           │
    │PUT(k,v)   │           │           │           │           │
    ├──────────►│           │           │           │           │
    │           │           │           │           │           │
    │           │Propose(data)          │           │           │
    │           ├──────────►│           │           │           │
    │           │           │           │           │           │
    │           │           │ Log       │           │           │
    │           │           │Replication│           │           │
    │           │           │(to peers) │           │           │
    │           │           │           │           │           │
    │           │           │Ready      │           │           │
    │           │           │Channel    │           │           │
    │           │           ├──────────►│           │           │
    │           │           │           │           │           │
    │           │           │           │Save       │           │
    │           │           │           │Snapshot   │           │
    │           │           │           │(if any)   │           │
    │           │           │           ├──────────►│           │
    │           │           │           │           │           │
    │           │           │           │Save       │           │
    │           │           │           │HardState+ │           │
    │           │           │           │Entries    │           │
    │           │           │           ├──────────►│           │
    │           │           │           │           │           │
    │           │           │           │Apply      │           │
    │           │           │           │Committed  │           │
    │           │           │           │Entries    │           │
    │           │           │           ├──────────────────────►│
    │           │           │           │           │           │
    │           │ Success   │           │           │           │
    │           │◄──────────┤           │           │           │
    │           │           │           │           │           │
    │ Success   │           │           │           │           │
    │◄──────────┤           │           │           │           │
    │           │           │           │           │           │
```

## 2. Read Operation Sequence

```
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│ Client │  │  Node  │  │  Raft  │  │ B+Tree │
│        │  │  API   │  │        │  │        │
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │
    │GET(key)   │           │           │
    ├──────────►│           │           │
    │           │           │           │
    │           │IsLeader() │           │
    │           ├──────────►│           │
    │           │           │           │
    │           │Yes        │           │
    │           │◄──────────┤           │
    │           │           │           │
    │           │           │           │
    │           │Get(key)   │           │
    │           ├──────────────────────►│
    │           │           │           │
    │           │value      │           │
    │           │◄──────────────────────┤
    │           │           │           │
    │ value     │           │           │
    │◄──────────┤           │           │
    │           │           │           │

Alternative: Redirect to Leader
    │           │           │           │
    │           │IsLeader() │           │
    │           ├──────────►│           │
    │           │           │           │
    │           │No         │           │
    │           │◄──────────┤           │
    │           │           │           │
    │Redirect   │           │           │
    │to Leader  │           │           │
    │◄──────────┤           │           │
    │           │           │           │
```

## 3. Leader Election Sequence

```
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│ Node1  │  │ Node2  │  │ Node3  │  │ Node4  │
│        │  │        │  │        │  │        │
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │
    │Election   │           │           │
    │Timeout    │           │           │
    │           │           │           │
    │Increment  │           │           │
    │Term       │           │           │
    │           │           │           │
    │RequestVote│           │           │
    ├──────────►│           │           │
    │           │           │           │
    │RequestVote│           │           │
    ├─────────────────────►│           │
    │           │           │           │
    │RequestVote│           │           │
    ├──────────────────────────────────►│
    │           │           │           │
    │Vote       │           │           │
    │◄──────────┤           │           │
    │           │           │           │
    │Vote       │           │           │
    │◄─────────────────────┤           │
    │           │           │           │
    │Reject     │           │           │
    │(old term) │           │           │
    │◄──────────────────────────────────┤
    │           │           │           │
    │Become     │           │           │
    │Leader     │           │           │
    │           │           │           │
    │AppendEntries (heartbeat)          │
    ├──────────►│           │           │
    │           │           │           │
    │AppendEntries (heartbeat)          │
    ├─────────────────────►│           │
    │           │           │           │
    │AppendEntries (heartbeat)          │
    ├──────────────────────────────────►│
    │           │           │           │
```

## 4. WAL Recovery Sequence

```
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│ System │  │  Node  │  │  WAL   │  │ B+Tree │  │  Raft  │
│        │  │        │  │        │  │        │  │        │
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │           │
    │Start      │           │           │           │
    │Node       │           │           │           │
    ├──────────►│           │           │           │
    │           │           │           │           │
    │           │Open       │           │           │
    │           │WAL        │           │           │
    │           ├──────────►│           │           │
    │           │           │           │           │
    │           │ReadAll()  │           │           │
    │           ├──────────►│           │           │
    │           │           │           │           │
    │           │[Records]  │           │           │
    │           │◄──────────┤           │           │
    │           │           │           │           │
    │           │Process Records       │           │
    │           │                      │           │
    │           │For each Snapshot:    │           │
    │           │  Restore()           │           │
    │           ├─────────────────────►│           │
    │           │                      │           │
    │           │For each Entry:       │           │
    │           │  Apply()             │           │
    │           ├─────────────────────►│           │
    │           │                      │           │
    │           │For each HardState:   │           │
    │           │  Restore()           │           │
    │           ├──────────────────────────────────►│
    │           │                      │           │
    │           │Recovery              │           │
    │           │Complete              │           │
    │           │                      │           │
    │Ready      │                      │           │
    │◄──────────┤                      │           │
    │           │                      │           │
```

## 5. Snapshot Creation and Application

```
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│ Leader │  │ Ready  │  │ B+Tree │  │  WAL   │  │Follower│
│  Node  │  │Handler │  │        │  │        │  │ Node   │
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │           │
    │Trigger    │           │           │           │
    │Snapshot   │           │           │           │
    ├──────────►│           │           │           │
    │           │           │           │           │
    │           │Create     │           │           │
    │           │Snapshot() │           │           │
    │           ├──────────►│           │           │
    │           │           │           │           │
    │           │Serialized │           │           │
    │           │Data       │           │           │
    │           │◄──────────┤           │           │
    │           │           │           │           │
    │           │Save       │           │           │
    │           │Snapshot   │           │           │
    │           ├──────────────────────►│           │
    │           │           │           │           │
    │           │Snapshot   │           │           │
    │           │in Ready   │           │           │
    │◄──────────┤           │           │           │
    │           │           │           │           │
    │Send       │           │           │           │
    │Snapshot   │           │           │           │
    │to Follower│           │           │           │
    ├──────────────────────────────────────────────►│
    │           │           │           │           │
    │           │           │           │           │Apply
    │           │           │           │           │Snapshot
    │           │           │           │           │
    │ACK        │           │           │           │
    │◄──────────────────────────────────────────────┤
    │           │           │           │           │
```

## 6. Error Handling Sequence

```
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│ Client │  │  Node  │  │ Ready  │  │  WAL   │  │ System │
│        │  │  API   │  │Handler │  │        │  │        │
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │           │
    │PUT(k,v)   │           │           │           │
    ├──────────►│           │           │           │
    │           │           │           │           │
    │           │... (normal flow until WAL write)  │
    │           │           │           │           │
    │           │           │Save       │           │
    │           │           │Entry      │           │
    │           │           ├──────────►│           │
    │           │           │           │           │
    │           │           │Disk       │           │
    │           │           │Full       │           │
    │           │           │Error      │           │
    │           │           │◄──────────┤           │
    │           │           │           │           │
    │           │Error      │           │           │
    │           │◄──────────┤           │           │
    │           │           │           │           │
    │           │Log Error  │           │           │
    │           ├──────────────────────────────────►│
    │           │           │           │           │
    │Error:     │           │           │           │
    │WAL Failed │           │           │           │
    │◄──────────┤           │           │           │
    │           │           │           │           │

Network Partition Error:
    │           │           │           │           │
    │PUT(k,v)   │           │           │           │
    ├──────────►│           │           │           │
    │           │           │           │           │
    │           │Check      │           │           │
    │           │Leadership │           │           │
    │           │           │           │           │
    │           │Not Leader │           │           │
    │           │(lost election due to partition)   │
    │           │           │           │           │
    │Error:     │           │           │           │
    │Not Leader │           │           │           │
    │◄──────────┤           │           │           │
    │           │           │           │           │
```

## 7. Complete Transaction Flow

```
┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│Client A│ │Client B│ │ Node1  │ │ Node2  │ │ Node3  │ │  WAL   │ │ B+Tree │
│        │ │        │ │(Leader)│ │(Follow)│ │(Follow)│ │        │ │        │
└───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘
    │          │          │          │          │          │          │
    │PUT(k1,v1)│          │          │          │          │          │
    ├─────────────────────►│          │          │          │          │
    │          │          │          │          │          │          │
    │          │PUT(k2,v2)│          │          │          │          │
    │          ├─────────►│          │          │          │          │
    │          │          │          │          │          │          │
    │          │          │Propose   │          │          │          │
    │          │          │k1,v1     │          │          │          │
    │          │          │(term=5,  │          │          │          │
    │          │          │ index=10)│          │          │          │
    │          │          │          │          │          │          │
    │          │          │Propose   │          │          │          │
    │          │          │k2,v2     │          │          │          │
    │          │          │(term=5,  │          │          │          │
    │          │          │ index=11)│          │          │          │
    │          │          │          │          │          │          │
    │          │          │AppendEntries        │          │          │
    │          │          │[Entry10,Entry11]    │          │          │
    │          │          ├─────────►│          │          │          │
    │          │          │          │          │          │          │
    │          │          │AppendEntries        │          │          │
    │          │          │[Entry10,Entry11]    │          │          │
    │          │          ├────────────────────►│          │          │
    │          │          │          │          │          │          │
    │          │          │Success   │          │          │          │
    │          │          │◄─────────┤          │          │          │
    │          │          │          │          │          │          │
    │          │          │Success   │          │          │          │
    │          │          │◄────────────────────┤          │          │
    │          │          │          │          │          │          │
    │          │          │Majority Achieved    │          │          │
    │          │          │-> Commit index=11   │          │          │
    │          │          │          │          │          │          │
    │          │          │Ready{    │          │          │          │
    │          │          │ HardState│          │          │          │
    │          │          │ Entries  │          │          │          │
    │          │          │ Committed│          │          │          │
    │          │          │}         │          │          │          │
    │          │          │          │          │          │          │
    │          │          │Save to WAL          │          │          │
    │          │          ├─────────────────────────────────►          │
    │          │          │          │          │          │          │
    │          │          │Apply Entries        │          │          │
    │          │          ├────────────────────────────────────────────►│
    │          │          │          │          │          │          │
    │          │          │PUT k1=v1 │          │          │          │
    │          │          │PUT k2=v2 │          │          │          │
    │          │          │          │          │          │          │
    │Success   │          │          │          │          │          │
    │◄─────────────────────┤          │          │          │          │
    │          │          │          │          │          │          │
    │          │Success   │          │          │          │          │
    │          │◄─────────┤          │          │          │          │
    │          │          │          │          │          │          │
```